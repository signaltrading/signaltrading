<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Pro Platform (Persisten V4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS Styles sama seperti versi "UI Ultra Keren" sebelumnya */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap');
        :root { --bg-primary: #0b0f19; --bg-secondary: #111827; --bg-card: rgba(17, 24, 39, 0.88); --border-color: rgba(55, 65, 81, 0.7); --text-primary: #e5e7eb; --text-secondary: #9ca3af; --accent-blue: #3b82f6; --accent-sky: #0ea5e9; --accent-green: #10b981; --accent-red: #ef4444; --accent-yellow: #f59e0b; --font-main: 'Inter', sans-serif; --font-display: 'Orbitron', sans-serif; }
        body { font-family: var(--font-main); background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.6; overflow-x: hidden; }
        .card-bg { background: var(--bg-card); backdrop-filter: blur(18px) saturate(150%); -webkit-backdrop-filter: blur(18px) saturate(150%); border: 1px solid var(--border-color); border-radius: 1rem; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(55, 65, 81, 0.3); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 1rem 1.75rem; border-radius: 0.75rem; box-shadow: 0 8px 25px rgba(0,0,0,0.4); z-index: 2000; opacity: 0; transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); font-size: 1rem; font-weight: 500; border-left-width: 4px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background-color: rgba(16, 185, 129, 0.9); border-left-color: #047857; color: white; }
        .toast.error   { background-color: rgba(239, 68, 68, 0.9); border-left-color: #b91c1c; color: white; }
        .toast.info    { background-color: rgba(59, 130, 246, 0.9); border-left-color: #1d4ed8; color: white; }
        .hidden-section { display: none; }
        .section-container { opacity: 0; transform: translateY(25px); animation: sectionFadeIn 0.7s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes sectionFadeIn { to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 9px; height: 9px; } ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 10px; } ::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.4); border-radius: 10px;} ::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 0.6); }
        .input-field, .select-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s; color: var(--text-primary); border-radius: 0.625rem; padding: 0.9rem 1.1rem; font-size: 0.95rem; }
        .input-field::placeholder { color: var(--text-secondary); } 
        .input-field:focus, .select-field:focus { border-color: var(--accent-sky); background-color: rgba(14,165,233,0.05); box-shadow: 0 0 0 3.5px rgba(14, 165, 233, 0.2); outline: none; }
        .btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 5px 0 rgba(0,0,0,0.2), 0 2px 5px -1px rgba(0,0,0,0.15); border-radius: 0.625rem; font-weight: 600; padding: 0.8rem 1.6rem; display: inline-flex; align-items: center; justify-content: center; border: none; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 5px 10px -1px rgba(0,0,0,0.25), 0 3px 5px -2px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(0px) scale(0.97); box-shadow: inset 0 3px 5px 0 rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(145deg, var(--accent-blue), #4f46e5); color:white; } 
        .btn-danger  { background: linear-gradient(145deg, var(--accent-red), #c2410c); color:white;} 
        .btn-success { background: linear-gradient(145deg, var(--accent-green), #065f46); color:white;} 
        .btn-warning { background: linear-gradient(145deg, var(--accent-yellow), #ca8a04); color:white;} 
        .btn-link { background: transparent; color: var(--accent-sky); box-shadow: none; padding: 0.5rem 0.2rem; text-transform: none; letter-spacing: normal;}
        .btn-link:hover { text-decoration: underline; color: #7dd3fc; }
        .subscription-option, .payment-option { border: 2px solid var(--border-color); transition: all 0.3s ease; border-radius: 0.75rem; }
        .subscription-option:hover, .payment-option:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .subscription-option.selected { border-color: var(--accent-sky); background-color: rgba(14, 165, 233, 0.15); box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); transform: scale(1.03); }
        .payment-option.selected { border-color: var(--accent-green); background-color: rgba(16, 185, 129, 0.15); box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); transform: scale(1.03); }
        .file-input-label { background-color: #4b5563; color: white; padding: 0.6rem 1.2rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: inline-block;} .file-input-label:hover { background-color: #6b7280; }
        .image-preview { max-height: 180px; max-width: 100%; border-radius: 0.5rem; margin-top: 0.75rem; border: 1px solid #4b5563; object-fit: contain; }
        .admin-list-item, .signal-card-item { background-color: rgba(30, 41, 59, 0.7); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border-color); transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out; }
        .admin-list-item:hover, .signal-card-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        #priceTickerContainer { position: sticky; top: 0; z-index: 10; background:var(--bg-primary); padding: 0.75rem 0; margin-bottom: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        #priceTicker { display: flex; overflow-x: auto; padding: 0.5rem 0; gap: 1rem; -ms-overflow-style: none; scrollbar-width: none; } #priceTicker::-webkit-scrollbar { display: none; }
        .price-ticker-item { min-width: 180px; padding: 0.8rem 1rem; border-radius: 0.625rem; background-color: var(--bg-secondary); border: 1px solid var(--border-color); transition: background-color 0.3s ease, transform 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.2); flex-shrink: 0; }
        .price-ticker-item .asset-name { font-family: var(--font-display); font-size: 1em; color: var(--accent-sky); font-weight: 500; }
        .price-value { font-family: var(--font-display); font-size: 1.6em; transition: color 0.3s ease, transform 0.2s ease; display: inline-block; text-shadow: 0 0 8px rgba(255,255,255,0.1); }
        .price-value-container { transition: background-color 0.5s ease-out; border-radius: 0.375rem; padding: 0.1rem 0.3rem; margin: 0.1rem 0; }
        .price-value-container.flash-up { background-color: rgba(16, 185, 129, 0.25); } .price-value-container.flash-down { background-color: rgba(239, 68, 68, 0.25); }
        .price-change-percent { font-size: 0.75em; }
        .price-up { color: var(--accent-green); } .price-down { color: var(--accent-red); } .price-neutral { color: var(--text-secondary); }
        .header-icon { animation: floatIcon 3s ease-in-out infinite alternate; } @keyframes floatIcon { 0% { transform: translateY(0px); } 100% { transform: translateY(-5px); } }
        .section-title { font-family: var(--font-display); letter-spacing: 1px; }
    </style>
</head>
<!-- HTML Structure sama seperti versi "UI Ultra Keren" sebelumnya -->
<!-- ... (Sisa HTML sama persis dengan versi sebelumnya) ... -->
<body class="min-h-screen flex flex-col items-center p-4 pt-6 sm:pt-10">

    <!-- Login Section -->
    <div id="loginSection" class="w-full max-w-md card-bg shadow-2xl p-6 sm:p-10 section-container">
        <div class="text-center mb-10"> <i class="fas fa-rocket fa-3x text-sky-400 header-icon"></i> <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 via-teal-300 to-emerald-400 mt-3 section-title">Signal Pro</h1> </div>
        <form id="loginForm" class="space-y-6">
            <div> <label for="username" class="block text-sm font-medium text-slate-300 mb-1.5">Username</label> <input type="text" id="username" required class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="password" class="block text-sm font-medium text-slate-300 mb-1.5">Password</label> <input type="password" id="password" required class="w-full input-field placeholder-slate-500"> </div>
            <button type="submit" class="w-full btn btn-primary text-white py-3"><i class="fas fa-key mr-2"></i>Masuk Platform</button>
        </form>
        <div class="mt-8 text-center"> <button id="showSubscriptionButton" class="btn-link text-sm font-medium">Baru di sini? <span class="underline">Buat Akun & Langganan</span></button> </div>
    </div>

    <!-- Subscription/Registration Section -->
    <div id="subscriptionSection" class="hidden-section w-full max-w-lg card-bg shadow-2xl p-6 sm:p-8 section-container">
        <h1 class="text-3xl font-bold text-sky-400 text-center mb-8 section-title">Registrasi Akun Baru</h1>
        <form id="subscriptionForm" class="space-y-6">
            <div> <label for="subNewUsername" class="block text-sm font-medium text-slate-300 mb-1.5">Username Baru</label> <input type="text" id="subNewUsername" required class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="subNewPassword" class="block text-sm font-medium text-slate-300 mb-1.5">Password Baru</label> <input type="password" id="subNewPassword" required class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="subEmail" class="block text-sm font-medium text-slate-300 mb-1.5">Alamat Email</label> <input type="email" id="subEmail" required class="w-full input-field placeholder-slate-500"> </div>
            <h3 class="text-lg font-semibold text-slate-100 pt-3">Pilih Paket Langganan:</h3>
            <div id="subscriptionOptionsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            <h3 class="text-lg font-semibold text-slate-100 pt-3">Metode Pembayaran:</h3>
            <div class="flex space-x-4">
                <button type="button" data-payment="DANA" class="payment-option flex-1 btn bg-blue-500 hover:bg-blue-600 text-white p-3"><i class="fas fa-mobile-alt mr-2"></i>DANA</button>
                <button type="button" data-payment="QRIS" class="payment-option flex-1 btn bg-slate-600 hover:bg-slate-500 text-white p-3"><i class="fas fa-qrcode mr-2"></i>QRIS</button>
            </div>
            <div id="paymentInfoDisplay" class="hidden-section mt-4 p-4 bg-slate-700/70 rounded-lg text-center text-sm"></div>
            <div>
                <label for="proofOfPayment" class="block text-sm font-medium text-slate-300 mb-2">Unggah Bukti Transfer (Max 2MB)</label>
                <input type="file" id="proofOfPayment" accept="image/jpeg, image/png" class="w-full text-sm text-slate-300 file:mr-4 file:py-2.5 file:px-5 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-500 file:text-white hover:file:bg-sky-600 cursor-pointer">
                <img id="proofPreview" src="#" alt="Preview Bukti" class="hidden-section image-preview"/>
            </div>
            <button type="submit" id="submitSubscriptionRequestButton" class="w-full btn btn-success text-white py-3"><i class="fas fa-rocket mr-2"></i>Kirim & Proses Langganan</button>
        </form>
        <div class="mt-8 text-center"> <button id="backToLoginButton" class="btn-link text-sm font-medium"><i class="fas fa-arrow-left mr-1.5"></i>Kembali ke Login</button> </div>
    </div>
    
    <!-- Profile Section -->
    <div id="profileSection" class="hidden-section w-full max-w-md card-bg shadow-2xl p-6 sm:p-8 section-container">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-sky-400 section-title">Profil Saya</h1>
            <button id="backToDashboardButton" class="btn-link text-sm"><i class="fas fa-arrow-left mr-1.5"></i>Kembali</button>
        </div>
        <form id="profileForm" class="space-y-6">
            <div> <label for="profileUsername" class="block text-sm font-medium text-slate-300 mb-1.5">Nama Pengguna (Tidak bisa diubah)</label> <input type="text" id="profileUsername" readonly class="w-full input-field bg-slate-700/50 cursor-not-allowed placeholder-slate-500"> </div>
            <div> <label for="profileDisplayName" class="block text-sm font-medium text-slate-300 mb-1.5">Nama Tampilan</label> <input type="text" id="profileDisplayName" class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="profileEmail" class="block text-sm font-medium text-slate-300 mb-1.5">Email (Tidak bisa diubah)</label> <input type="email" id="profileEmail" readonly class="w-full input-field bg-slate-700/50 cursor-not-allowed placeholder-slate-500"> </div>
            <div> <label for="profileCurrentPassword" class="block text-sm font-medium text-slate-300 mb-1.5">Password Saat Ini (untuk ganti password)</label> <input type="password" id="profileCurrentPassword" class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="profileNewPassword" class="block text-sm font-medium text-slate-300 mb-1.5">Password Baru (kosongkan jika tidak ganti)</label> <input type="password" id="profileNewPassword" class="w-full input-field placeholder-slate-500"> </div>
            <div> <label for="profileConfirmNewPassword" class="block text-sm font-medium text-slate-300 mb-1.5">Konfirmasi Password Baru</label> <input type="password" id="profileConfirmNewPassword" class="w-full input-field placeholder-slate-500"> </div>
            <button type="submit" class="w-full btn btn-primary text-white py-3"><i class="fas fa-save mr-2"></i>Simpan Perubahan Profil</button>
        </form>
    </div>

    <!-- Admin Section -->
    <div id="adminSection" class="hidden-section w-full max-w-6xl mt-6 px-4 section-container">
        <header class="mb-10 card-bg p-5"> <div class="flex justify-between items-center"> <div class="flex items-center"> <i class="fas fa-user-shield fa-2x text-sky-400 mr-4"></i> <h1 class="text-3xl font-bold text-sky-400 section-title">Dasbor Admin</h1> </div> <div class="flex items-center space-x-3"><button id="adminProfileButton" class="btn btn-primary text-xs py-2 px-3"><i class="fas fa-user-edit mr-1"></i>Profil</button><button id="adminLogoutButton" class="btn btn-danger text-xs py-2 px-3"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button> </div> </div> <p class="text-sm text-slate-300 mt-2">Selamat datang, <span id="adminNameDisplay" class="font-semibold">Admin</span>!</p> </header>
        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid md:grid-cols-2 gap-8">
                <div class="card-bg p-6"> <h2 class="text-xl font-semibold text-sky-300 mb-5 flex items-center"><i class="fas fa-cogs mr-3"></i>Pengaturan Platform</h2> <div class="space-y-6"> <div> <h3 class="text-lg font-medium mb-3 text-slate-100">Detail Pembayaran</h3> <form id="paymentSettingsForm" class="space-y-4"> <div><label for="danaNumber" class="block text-sm mb-1.5">No. Rek/DANA</label><input type="text" id="danaNumber" class="w-full input-field" placeholder="0812xxxx"></div> <div><label for="qrisImageUpload" class="block text-sm mb-1.5">Unggah Gambar QRIS</label><input type="file" id="qrisImageUpload" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-500 file:text-white hover:file:bg-sky-600"><img id="qrisAdminPreview" src="#" alt="QRIS" class="hidden-section image-preview"/></div> <button type="submit" class="w-full btn btn-warning text-white"><i class="fas fa-save mr-2"></i>Simpan Info Bayar</button> </form> <div class="mt-3 text-xs"><p>DANA: <span id="currentDanaDisplay" class="font-semibold text-sky-300">Belum diatur</span></p><p>QRIS: <span id="currentQrisDisplay" class="font-semibold text-sky-300">Belum diatur</span></p><img id="currentQrisImageDisplay" src="#" alt="QRIS" class="hidden-section image-preview w-28 h-28 object-contain"/></div> </div> <div> <h3 class="text-lg font-medium mb-3 text-slate-100">Harga Paket</h3> <form id="setPricesForm" class="space-y-4"> <div><label for="priceDay" class="block text-sm mb-1.5">1 Hari (Rp)</label><input type="number" id="priceDay" required class="w-full input-field" placeholder="10000"></div> <div><label for="priceWeek" class="block text-sm mb-1.5">1 Minggu (Rp)</label><input type="number" id="priceWeek" required class="w-full input-field" placeholder="50000"></div> <div><label for="priceMonth" class="block text-sm mb-1.5">1 Bulan (Rp)</label><input type="number" id="priceMonth" required class="w-full input-field" placeholder="150000"></div> <button type="submit" class="w-full btn btn-warning text-white"><i class="fas fa-tags mr-2"></i>Simpan Harga</button> </form> </div> </div> </div>
                <div class="card-bg p-6"> <h2 class="text-xl font-semibold text-sky-300 mb-5 flex items-center"><i class="fas fa-bullhorn mr-3"></i>Manajemen Konten & User</h2> <div class="space-y-6"> <div> <h3 class="text-lg font-medium mb-3">Rilis Sinyal Baru</h3> <form id="signalFormAdmin" class="space-y-3"> <div><label for="assetAdmin" class="block text-xs font-medium">Aset</label><input type="text" id="assetAdmin" required class="w-full input-field p-2 text-sm"></div> <div><label for="actionAdmin" class="block text-xs font-medium">Aksi</label><select id="actionAdmin" required class="w-full input-field p-2 text-sm"><option value="BUY">BUY</option><option value="SELL">SELL</option></select></div> <div><label for="notesAdmin" class="block text-xs font-medium">Catatan Analisa</label><textarea id="notesAdmin" rows="2" class="w-full input-field p-2 text-sm"></textarea></div> <button type="submit" class="w-full btn btn-success text-white text-sm"><i class="fas fa-paper-plane mr-1.5"></i>Rilis Sinyal</button> </form> <div class="mt-3"><h4 class="text-sm font-medium mb-1.5">Riwayat Sinyal</h4><div id="sentSignalsListAdmin" class="space-y-1.5 max-h-28 overflow-y-auto pr-0.5 text-xs"><p class="text-slate-400">Kosong.</p></div></div> </div> <div> <h3 class="text-lg font-medium mb-3">Tambah User Manual</h3> <form id="createUserForm" class="space-y-3 mb-3"> <div><label for="newUsername" class="block text-xs font-medium">Username</label><input type="text" id="newUsername" required class="w-full input-field p-2 text-sm"></div> <div><label for="newPassword" class="block text-xs font-medium">Password</label><input type="text" id="newPassword" required class="w-full input-field p-2 text-sm"></div> <div><label for="expiryDateTime" class="block text-xs font-medium">Aktif Hingga</label><input type="datetime-local" id="expiryDateTime" required class="w-full input-field p-2 text-sm text-slate-300"></div> <button type="submit" class="w-full btn btn-primary text-white text-sm"><i class="fas fa-user-plus mr-1.5"></i>Tambah User</button> </form> <div class="mt-3"><h4 class="text-sm font-medium mb-1.5">Daftar User</h4><div id="createdUsersListAdmin" class="space-y-1.5 max-h-28 overflow-y-auto pr-0.5 text-xs"><p class="text-slate-400">Kosong.</p></div></div> </div> </div> </div>
            </div>
            <div class="lg:col-span-1 card-bg p-6">
                <h2 class="text-xl font-semibold text-sky-300 mb-5 flex items-center"><i class="fas fa-user-check mr-3"></i>Validasi Langganan</h2>
                <div id="pendingSubscriptionsList" class="space-y-4 max-h-[calc(100vh-250px)] overflow-y-auto pr-1">
                    <p class="text-slate-400 text-center">Tidak ada permintaan validasi.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Section -->
    <div id="userSection" class="hidden-section w-full max-w-5xl mt-6 px-2 sm:px-4 section-container"> 
        <header class="mb-6 card-bg p-5"> 
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3"> 
                <div class="flex items-center">
                    <i class="fas fa-tachometer-alt fa-2x text-sky-400 mr-4"></i>
                    <h1 class="text-3xl font-bold text-sky-400 section-title">Dasbor Saya</h1>
                </div> 
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-slate-300">Halo, <span id="userNameDisplay" class="font-semibold">User</span>!</span>
                    <button id="userProfileButton" class="btn btn-primary text-xs py-2 px-3"><i class="fas fa-user-circle mr-1"></i>Profil</button>
                    <button id="userLogoutButton" class="btn btn-danger text-xs py-2 px-3"><i class="fas fa-door-open mr-1"></i>Logout</button> 
                </div>
            </div> 
        </header> 
        
        <div id="priceTickerContainer" class="mb-8">
            <div id="priceTicker" class="card-bg p-4">
                <!-- Ticker items akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <div class="card-bg p-5">
            <h2 class="text-2xl font-semibold text-sky-300 mb-5 section-title text-center sm:text-left"><i class="fas fa-lightbulb mr-2"></i> Sinyal Pilihan Hari Ini</h2> 
            <main id="signalsContainerUser" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="loadingMessageUser" class="text-slate-400 text-center py-10 md:col-span-2 lg:col-span-3">Memuat sinyal...</p>
            </main> 
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- Kunci LocalStorage ---
        const LS_KEYS = { currentUser: 'signalPro_currentUser_v4', signals: 'signalPro_signalsArray_v4', users: 'signalPro_userCredentials_v4', prices: 'signalPro_subscriptionPrices_v4', paymentDetails: 'signalPro_adminPaymentDetails_v4', pendingSubs: 'signalPro_pendingSubscriptions_v4' };

        // --- Fungsi Helper LocalStorage ---
        function saveData(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error("Error saving LS:", e); showToast("Gagal simpan data.", "error"); } }
        function loadData(key, defaultValue = null) { try { const item = localStorage.getItem(key); if (item === null) return defaultValue; const parsed = JSON.parse(item); return parsed === null ? defaultValue : parsed; /* Handle jika localStorage berisi "null" string */ } catch (e) { console.error("Error loading LS for key "+key+":", e); return defaultValue; } }
        function parseDatesInArray(arr, dateFields) { if (!arr || !Array.isArray(arr)) return []; return arr.map(item => { if (typeof item !== 'object' || item === null) return item; const newItem = { ...item }; dateFields.forEach(field => { if (newItem[field] && typeof newItem[field] === 'string') { const d = new Date(newItem[field]); if (!isNaN(d.getTime())) newItem[field] = d; else console.warn(`Invalid date string for field ${field}:`, newItem[field]); }}); return newItem; });}

        // --- Data Lokal ---
        const defaultUserCredentials = [ { username: 'Ilham', password: '592007', role: 'admin', displayName: 'Ilham (Admin)', expiry: null, createdAt: new Date(0), email: 'admin@signalpro.com', status: 'active' }, { username: 'user', password: 'user', role: 'user', displayName: 'Pengguna Awal', expiry: null, createdAt: new Date(0), email: 'user@signalpro.com', status: 'active' } ];
        const defaultSubscriptionPrices = { day: 15000, week: 75000, month: 250000 };
        const defaultAdminPaymentDetails = { danaNumber: '', qrisImage: null };

        let signalsArray = parseDatesInArray(loadData(LS_KEYS.signals, []), ['timestamp']);
        let userCredentialsArray = parseDatesInArray(loadData(LS_KEYS.users, defaultUserCredentials), ['expiry', 'createdAt']);
        let currentUser = loadData(LS_KEYS.currentUser); 
        let subscriptionPrices = loadData(LS_KEYS.prices, defaultSubscriptionPrices);
        let adminPaymentDetails = loadData(LS_KEYS.paymentDetails, defaultAdminPaymentDetails);
        let pendingSubscriptions = parseDatesInArray(loadData(LS_KEYS.pendingSubs, []), ['requestTimestamp']);
        
        let selectedSubscriptionDuration = null; 
        let selectedPaymentMethod = null;
        let uploadedProofDataUrl = null;
        const mockMarketAssets = [ { name: 'BTC/IDR', price: 1050000000.00, change: 0, direction: 'neutral', decimals: 0, lastPrices: []},{ name: 'ETH/USD', price: 3550.25, change: 0, direction: 'neutral', decimals: 2, lastPrices: []}, { name: 'XAU/USD', price: 2350.80, change: 0, direction: 'neutral', decimals: 2, lastPrices: []}, { name: 'EUR/IDR', price: 17520.00, change: 0, direction: 'neutral', decimals: 0, lastPrices: [] }];
        let tickerIntervalId = null;

        // --- Referensi DOM ---
        // ... (Lengkapi semua referensi DOM, pastikan tidak ada yang null karena salah ID)
        const loginSection = document.getElementById('loginSection'); const subscriptionSection = document.getElementById('subscriptionSection'); const adminSection = document.getElementById('adminSection'); const userSection = document.getElementById('userSection'); const profileSection = document.getElementById('profileSection'); const loginForm = document.getElementById('loginForm'); const showSubscriptionButton = document.getElementById('showSubscriptionButton'); const subscriptionForm = document.getElementById('subscriptionForm'); const subscriptionOptionsContainer = document.getElementById('subscriptionOptionsContainer'); const paymentInfoDisplay = document.getElementById('paymentInfoDisplay'); const submitSubscriptionRequestButton = document.getElementById('submitSubscriptionRequestButton');  const backToLoginButton = document.getElementById('backToLoginButton'); const adminNameDisplay = document.getElementById('adminNameDisplay'); const signalFormAdmin = document.getElementById('signalFormAdmin'); const sentSignalsListAdmin = document.getElementById('sentSignalsListAdmin'); const createUserForm = document.getElementById('createUserForm'); const createdUsersListAdmin = document.getElementById('createdUsersListAdmin'); const setPricesForm = document.getElementById('setPricesForm'); const adminLogoutButton = document.getElementById('adminLogoutButton'); const paymentSettingsForm = document.getElementById('paymentSettingsForm'); const danaNumberInput = document.getElementById('danaNumber'); const qrisImageUploadInput = document.getElementById('qrisImageUpload'); const qrisAdminPreview = document.getElementById('qrisAdminPreview'); const currentDanaDisplay = document.getElementById('currentDanaDisplay'); const currentQrisDisplay = document.getElementById('currentQrisDisplay'); const currentQrisImageDisplay = document.getElementById('currentQrisImageDisplay'); const pendingSubscriptionsList = document.getElementById('pendingSubscriptionsList'); const subNewUsernameInput = document.getElementById('subNewUsername');  const subNewPasswordInput = document.getElementById('subNewPassword');  const subEmailInput = document.getElementById('subEmail'); const proofOfPaymentInput = document.getElementById('proofOfPayment'); const proofPreview = document.getElementById('proofPreview'); const userNameDisplay = document.getElementById('userNameDisplay'); const signalsContainerUser = document.getElementById('signalsContainerUser'); const tickerItemsContainer = document.getElementById('tickerItemsContainer'); const priceTickerContainer = document.getElementById('priceTickerContainer');  const profileForm = document.getElementById('profileForm'); const profileUsernameInput = document.getElementById('profileUsername'); const profileDisplayNameInput = document.getElementById('profileDisplayName'); const profileEmailInput = document.getElementById('profileEmail'); const profileCurrentPasswordInput = document.getElementById('profileCurrentPassword'); const profileNewPasswordInput = document.getElementById('profileNewPassword'); const profileConfirmNewPasswordInput = document.getElementById('profileConfirmNewPassword'); const backToDashboardButton = document.getElementById('backToDashboardButton'); const adminProfileButton = document.getElementById('adminProfileButton'); const userProfileButton = document.getElementById('userProfileButton');

        // --- Fungsi UI & Helper ---
        function showSection(sectionId) { [loginSection,subscriptionSection,adminSection,userSection,profileSection].forEach(s=>{if(s)s.style.display='none';}); const ts=document.getElementById(sectionId); if(ts){ts.style.display='block';ts.classList.add('section-container');setTimeout(()=>ts.classList.remove('section-container'),700);} }
        function showToast(message, type = 'success') { const tc=document.getElementById('toast-container'),t=document.createElement('div');t.className=`toast ${type}`;t.textContent=message;tc.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.parentNode?.removeChild(t),300);},3500);}
        function logout() { currentUser = null; localStorage.removeItem(LS_KEYS.currentUser); showSection('loginSection'); stopPriceTicker(); }
        if(adminLogoutButton) adminLogoutButton.addEventListener('click', logout);
        if(userLogoutButton) userLogoutButton.addEventListener('click', logout);
        if(showSubscriptionButton) showSubscriptionButton.addEventListener('click', () => { renderSubscriptionOptions(); showSection('subscriptionSection'); });
        if(backToLoginButton) backToLoginButton.addEventListener('click', () => showSection('loginSection'));
        function readFileAsDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        
        // --- Navigasi & Update Profil ---
        function openProfilePage() { if(!currentUser)return;profileUsernameInput.value=currentUser.username;profileDisplayNameInput.value=currentUser.displayName||currentUser.username;profileEmailInput.value=currentUser.email;profileCurrentPasswordInput.value='';profileNewPasswordInput.value='';profileConfirmNewPasswordInput.value='';showSection('profileSection');}
        if(adminProfileButton) adminProfileButton.addEventListener('click', openProfilePage);
        if(userProfileButton) userProfileButton.addEventListener('click', openProfilePage);
        if(backToDashboardButton) backToDashboardButton.addEventListener('click', () => { if(currentUser.role==='admin')showSection('adminSection'); else showSection('userSection'); });
        if(profileForm) profileForm.addEventListener('submit', (e) => { e.preventDefault();if(!currentUser){showToast('Sesi tidak valid.','error');return;}const cP=profileCurrentPasswordInput.value,nP=profileNewPasswordInput.value,cN=profileConfirmNewPasswordInput.value,nD=profileDisplayNameInput.value.trim();const uIdx=userCredentialsArray.findIndex(u=>u.username===currentUser.username);if(uIdx===-1){showToast('User tidak ditemukan.','error');return;}const uD=userCredentialsArray[uIdx];let updated=false;if(nD&&nD!==uD.displayName){uD.displayName=nD;currentUser.displayName=nD;if(currentUser.role==='admin')adminNameDisplay.textContent=nD;else userNameDisplay.textContent=nD;updated=true;}if(nP){if(cP!==uD.password){showToast('Password saat ini salah.','error');return;}if(nP!==cN){showToast('Password baru & konfirmasi tidak cocok.','error');return;}uD.password=nP;updated=true;}if(updated){saveData(LS_KEYS.users,userCredentialsArray);saveData(LS_KEYS.currentUser, currentUser); /* Simpan juga perubahan displayName ke sesi */}showToast('Profil berhasil diperbarui!','success');profileCurrentPasswordInput.value='';profileNewPasswordInput.value='';profileConfirmNewPasswordInput.value='';});

        // --- Admin: Pengaturan Pembayaran ---
        if(paymentSettingsForm) paymentSettingsForm.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const newDanaNumber = danaNumberInput.value.trim();
            const qrisFile = qrisImageUploadInput.files[0];
            let newQrisImage = adminPaymentDetails.qrisImage; // Pertahankan gambar lama jika tidak ada file baru

            if (qrisFile) {
                try {
                    newQrisImage = await readFileAsDataURL(qrisFile);
                } catch (err) {
                    showToast('Gagal memuat gambar QRIS baru.', 'error');
                    // Tidak mengubah newQrisImage, jadi gambar lama (jika ada) tetap
                }
            }
            adminPaymentDetails = { danaNumber: newDanaNumber, qrisImage: newQrisImage }; // Update objek utama
            updateAdminPaymentDisplay();
            saveData(LS_KEYS.paymentDetails, adminPaymentDetails);
            showToast('Pengaturan pembayaran disimpan!', 'success');
            qrisImageUploadInput.value = ''; // Kosongkan input file setelah submit
        });

        function updateAdminPaymentDisplay() { 
            if(!currentDanaDisplay || !currentQrisImageDisplay || !currentQrisDisplay || !qrisAdminPreview || !danaNumberInput) return;
            danaNumberInput.value = adminPaymentDetails.danaNumber || ''; 
            currentDanaDisplay.textContent = adminPaymentDetails.danaNumber || 'Belum diatur';
            if (adminPaymentDetails.qrisImage) {
                qrisAdminPreview.src = adminPaymentDetails.qrisImage;
                qrisAdminPreview.classList.remove('hidden-section');
                currentQrisImageDisplay.src = adminPaymentDetails.qrisImage;
                currentQrisImageDisplay.classList.remove('hidden-section');
                currentQrisDisplay.textContent = 'Sudah diunggah';
            } else {
                qrisAdminPreview.src = '#'; 
                qrisAdminPreview.classList.add('hidden-section');
                currentQrisImageDisplay.src = '#';
                currentQrisImageDisplay.classList.add('hidden-section');
                currentQrisDisplay.textContent = 'Belum diatur';
            }
        }
        if(qrisImageUploadInput) qrisImageUploadInput.addEventListener('change', async (event) => { const file=event.target.files[0];if(file){try{const dUrl=await readFileAsDataURL(file);qrisAdminPreview.src=dUrl;qrisAdminPreview.classList.remove('hidden-section');}catch(err){showToast('Gagal preview QRIS.','error');qrisAdminPreview.classList.add('hidden-section');}}else{qrisAdminPreview.classList.add('hidden-section');}});

        // --- Registrasi & Langganan ---
        // ... (Fungsi sama, pastikan ID DOM benar)
        function renderSubscriptionOptions() { if(!subscriptionOptionsContainer) return; subscriptionOptionsContainer.innerHTML = ''; const opts = [{ id: 'day', label: '1 Hari', price: subscriptionPrices.day, icon: 'fa-sun' },{ id: 'week', label: '1 Minggu', price: subscriptionPrices.week, icon: 'fa-calendar-week' },{ id: 'month', label: '1 Bulan', price: subscriptionPrices.month, icon: 'fa-calendar-alt' }]; opts.forEach(opt => {const btn=document.createElement('button');btn.type='button';btn.dataset.duration=opt.id; btn.className=`subscription-option p-4 text-left transform hover:scale-105 ${selectedSubscriptionDuration===opt.id?'selected':''}`; btn.innerHTML=`<div class="flex items-center mb-1.5"><i class="fas ${opt.icon} text-sky-400 mr-2.5 text-lg"></i><span class="font-semibold text-md">${opt.label}</span></div><div class="text-xl font-bold">Rp ${opt.price.toLocaleString('id-ID')}</div>`; btn.addEventListener('click',()=>{selectedSubscriptionDuration=opt.id;renderSubscriptionOptions();}); subscriptionOptionsContainer.appendChild(btn);});}
        document.querySelectorAll('.payment-option').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.payment-option').forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); selectedPaymentMethod = button.dataset.payment; paymentInfoDisplay.classList.remove('hidden-section'); if (selectedPaymentMethod === 'DANA') { paymentInfoDisplay.innerHTML = adminPaymentDetails.danaNumber ? `Transfer ke DANA: <strong class="text-sky-300 block mt-1 text-lg">${adminPaymentDetails.danaNumber}</strong>` : '<span class="text-red-400">Nomor DANA Admin belum diatur.</span>'; } else if (selectedPaymentMethod === 'QRIS') { paymentInfoDisplay.innerHTML = adminPaymentDetails.qrisImage ? `Scan QRIS ini:<br><img src="${adminPaymentDetails.qrisImage}" alt="QRIS Admin" class="image-preview mx-auto mt-2">` : '<span class="text-red-400">Gambar QRIS Admin belum diatur.</span>'; } }); });
        if(proofOfPaymentInput) proofOfPaymentInput.addEventListener('change', async (event) => { const file=event.target.files[0];if(file){if(file.size > 2*1024*1024){showToast('Ukuran file maks 2MB.','error');proofOfPaymentInput.value='';proofPreview.classList.add('hidden-section');uploadedProofDataUrl=null;return;}try{uploadedProofDataUrl=await readFileAsDataURL(file);proofPreview.src=uploadedProofDataUrl;proofPreview.classList.remove('hidden-section');}catch(err){showToast('Gagal preview bukti.','error');uploadedProofDataUrl=null;}}else{proofPreview.classList.add('hidden-section');uploadedProofDataUrl=null;}});
        if(subscriptionForm) subscriptionForm.addEventListener('submit', (e) => { e.preventDefault();const nu=subNewUsernameInput.value.trim(),np=subNewPasswordInput.value,em=subEmailInput.value.trim();if(!nu||!np||!em){showToast('Username, Pass, Email wajib.','error');return;}if(!selectedSubscriptionDuration){showToast('Pilih durasi.','error');return;}if(!selectedPaymentMethod){showToast('Pilih metode bayar.','error');return;}if(!uploadedProofDataUrl){showToast('Unggah bukti bayar.','error');return;}if(userCredentialsArray.find(u=>u.username===nu)||pendingSubscriptions.find(p=>p.username===nu)){showToast(`Username "${nu}" sudah ada/pending.`,'error');return;}if((selectedPaymentMethod==='DANA'&&!adminPaymentDetails.danaNumber)||(selectedPaymentMethod==='QRIS'&&!adminPaymentDetails.qrisImage)){showToast('Info bayar Admin belum lengkap.','error');return;}submitSubscriptionRequestButton.disabled=true;submitSubscriptionRequestButton.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Mengirim...';pendingSubscriptions.unshift({id:Date.now().toString(),username:nu,password:np,email:em,planDuration:selectedSubscriptionDuration,paymentMethod:selectedPaymentMethod,proofImage:uploadedProofDataUrl,requestTimestamp:new Date()});saveData(LS_KEYS.pendingSubs,pendingSubscriptions);setTimeout(()=>{showToast('Permintaan dikirim! Tunggu konfirmasi.','success');subscriptionForm.reset();proofPreview.classList.add('hidden-section');uploadedProofDataUrl=null;selectedSubscriptionDuration=null;selectedPaymentMethod=null;document.querySelectorAll('.payment-option, .subscription-option').forEach(b=>b.classList.remove('selected'));paymentInfoDisplay.classList.add('hidden-section');showSection('loginSection');renderAdminPendingSubscriptions();submitSubscriptionRequestButton.disabled=false;submitSubscriptionRequestButton.innerHTML='<i class="fas fa-rocket mr-2"></i>Kirim & Proses Langganan';},1500);});

        // --- Login ---
        if(loginForm) loginForm.addEventListener('submit', (e) => { e.preventDefault();const uIn=loginForm.username.value,pIn=loginForm.password.value;const fU=userCredentialsArray.find(c=>c.username===uIn&&c.password===pIn);if(fU){if(fU.status==='pending'){showToast(`Akun ${fU.username} menunggu konfirmasi.`,'info');loginForm.reset();return;}if(fU.expiry&&new Date(fU.expiry)<new Date()){showToast(`Akun ${fU.displayName||fU.username} kedaluwarsa.`,'error');loginForm.reset();return;}currentUser={username:fU.username,role:fU.role,email:fU.email,displayName:fU.displayName||fU.username};saveData(LS_KEYS.currentUser,currentUser);if(fU.role==='admin'){adminNameDisplay.textContent=currentUser.displayName;document.getElementById('priceDay').value=subscriptionPrices.day;document.getElementById('priceWeek').value=subscriptionPrices.week;document.getElementById('priceMonth').value=subscriptionPrices.month; updateAdminPaymentDisplay(); /* Ini akan mengisi danaNumberInput & qrisAdminPreview */ renderAdminPendingSubscriptions();showSection('adminSection');renderAdminSentSignals();renderAdminCreatedUsers();}else{userNameDisplay.textContent=currentUser.displayName;showSection('userSection');renderUserSignals();startPriceTicker();}}else{showToast('Username/password salah.','error');}loginForm.reset();});

        // --- Admin: Konfirmasi Langganan ---
        // ... (Sama, pastikan ID DOM dan class benar)
        function renderAdminPendingSubscriptions() { if(!pendingSubscriptionsList)return; pendingSubscriptionsList.innerHTML = ''; if (pendingSubscriptions.length === 0) { pendingSubscriptionsList.innerHTML = '<p class="text-slate-400 text-center py-4">Tidak ada permintaan.</p>'; return; } pendingSubscriptions.forEach(req => { const item = document.createElement('div'); item.className = 'admin-list-item text-xs space-y-2'; item.innerHTML = `<div><p><strong>User:</strong> <span class="font-medium text-sky-300">${req.username}</span></p><p><strong>Email:</strong> ${req.email}</p></div><div><p><strong>Paket:</strong> ${req.planDuration.charAt(0).toUpperCase() + req.planDuration.slice(1)}</p><p><strong>Metode:</strong> ${req.paymentMethod}</p></div><p class="mt-1.5"><strong>Bukti Bayar:</strong><img src="${req.proofImage}" alt="Bukti" class="image-preview w-full object-contain cursor-pointer border-slate-500 mt-1" onclick="this.classList.toggle('fixed');this.classList.toggle('inset-0');this.classList.toggle('m-auto');this.classList.toggle('z-50');this.classList.toggle('max-w-xl');this.classList.toggle('max-h-[90vh]');this.classList.toggle('bg-black/80');this.classList.toggle('p-4');this.classList.toggle('rounded-lg');"></p><p class="text-slate-400 text-xs mt-1.5">Diminta: ${new Date(req.requestTimestamp).toLocaleString('id-ID',{dateStyle:'medium', timeStyle:'short'})}</p><button onclick="confirmSubscription('${req.id}')" class="w-full btn btn-success text-xs mt-2.5 py-2"><i class="fas fa-user-check mr-1.5"></i>Konfirmasi & Aktifkan</button>`; pendingSubscriptionsList.appendChild(item); }); }
        window.confirmSubscription = confirmSubscription;
        function confirmSubscription(reqId) { const reqIdx=pendingSubscriptions.findIndex(r=>r.id===reqId);if(reqIdx===-1){showToast('Permintaan tidak ditemukan.','error');return;}const req=pendingSubscriptions[reqIdx];let expD=new Date();if(req.planDuration==='day')expD.setDate(expD.getDate()+1);else if(req.planDuration==='week')expD.setDate(expD.getDate()+7);else if(req.planDuration==='month')expD.setMonth(expD.getMonth()+1);userCredentialsArray.push({username:req.username,password:req.password,role:'user',email:req.email,displayName:req.username,expiry:expD,createdAt:new Date(req.requestTimestamp),status:'active'});saveData(LS_KEYS.users,userCredentialsArray);pendingSubscriptions.splice(reqIdx,1);saveData(LS_KEYS.pendingSubs,pendingSubscriptions);showToast(`Langganan ${req.username} dikonfirmasi! Akun aktif. Info "dikirim" ke ${req.email}`,'success');renderAdminPendingSubscriptions();renderAdminCreatedUsers();}

        // --- Admin: Fungsi Lainnya ---
        // ... (Sama, pastikan ID DOM dan class benar, dan saveData dipanggil)
        if(setPricesForm) setPricesForm.addEventListener('submit', (e) => { e.preventDefault();if(!currentUser||currentUser.role!=='admin')return;const pD=parseInt(document.getElementById('priceDay').value),pW=parseInt(document.getElementById('priceWeek').value),pM=parseInt(document.getElementById('priceMonth').value);if(isNaN(pD)||isNaN(pW)||isNaN(pM)||pD<0||pW<0||pM<0){showToast('Harga harus angka positif.','error');return;}subscriptionPrices={day:pD,week:pW,month:pM};saveData(LS_KEYS.prices,subscriptionPrices);showToast('Harga langganan diperbarui!','success');renderSubscriptionOptions();});
        if(signalFormAdmin) signalFormAdmin.addEventListener('submit', (e) => { e.preventDefault();if(!currentUser||currentUser.role!=='admin')return;const asset=document.getElementById('assetAdmin').value.trim().toUpperCase(),action=document.getElementById('actionAdmin').value,notes=document.getElementById('notesAdmin').value.trim();if(!asset){showToast('Aset wajib diisi.','error');return;}signalsArray.unshift({id:Date.now().toString(),asset,action,notes,timestamp:new Date(),createdBy:currentUser.username});saveData(LS_KEYS.signals,signalsArray);showToast('Sinyal dikirim!','success');signalFormAdmin.reset();renderAdminSentSignals();if(userSection.style.display==='block')renderUserSignals();});
        function renderAdminSentSignals() { if(!sentSignalsListAdmin) return; sentSignalsListAdmin.innerHTML = ''; const rS = signalsArray.slice(0,3); if (rS.length === 0) { sentSignalsListAdmin.innerHTML = '<p class="text-slate-400 text-center">Kosong.</p>'; return; } rS.forEach(s => { const el = document.createElement('div'); el.className = `admin-list-item text-xs flex justify-between items-center ${s.action === 'BUY' ? 'border-l-4 border-emerald-500' : 'border-l-4 border-red-500'}`; el.innerHTML = `<div><strong class="block text-sm">${s.action} ${s.asset}</strong><span class="text-slate-400">(${new Date(s.timestamp).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})})</span><p class="text-slate-300 italic mt-0.5 text-[0.7rem] leading-tight">${s.notes || '-tanpa catatan-'}</p></div><button onclick="deleteSignal('${s.id}')" class="btn btn-danger text-xs p-1.5"><i class="fas fa-times"></i></button>`; sentSignalsListAdmin.appendChild(el); }); }
        window.deleteSignal = deleteSignal; function deleteSignal(sId) { signalsArray=signalsArray.filter(s=>s.id!==sId);saveData(LS_KEYS.signals,signalsArray);showToast('Sinyal dihapus.','success');renderAdminSentSignals();if(userSection.style.display==='block')renderUserSignals();}
        if(createUserForm) createUserForm.addEventListener('submit', (e) => { e.preventDefault();if(!currentUser||currentUser.role!=='admin')return;const nu=document.getElementById('newUsername').value.trim(),np=document.getElementById('newPassword').value,edt=document.getElementById('expiryDateTime').value;if(!nu||!np||!edt){showToast('Semua field user wajib.','error');return;}if(userCredentialsArray.find(u=>u.username===nu)||pendingSubscriptions.find(p=>p.username===nu)){showToast(`Username "${nu}" sudah ada/pending.`,'error');return;}const expD=new Date(edt);if(isNaN(expD.getTime())){showToast('Format waktu tidak valid.','error');return;}userCredentialsArray.push({username:nu,password:np,role:'user',expiry:expD,createdAt:new Date(),email:`${nu}@example.com`,displayName:nu,status:'active'});saveData(LS_KEYS.users,userCredentialsArray);showToast(`User ${nu} dibuat!`,'success');createUserForm.reset();renderAdminCreatedUsers();});
        function renderAdminCreatedUsers() { if(!createdUsersListAdmin) return; createdUsersListAdmin.innerHTML = ''; const cO = userCredentialsArray.filter(u=>u.username!=='Ilham'&&u.username!=='user').sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,3); if(cO.length===0){createdUsersListAdmin.innerHTML='<p class="text-slate-400 text-center">Kosong.</p>'; return;} cO.forEach(u=>{const el=document.createElement('div'); el.className='admin-list-item text-xs flex justify-between items-center'; const exp=u.expiry?new Date(u.expiry).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}):'Permanen'; const iE=u.expiry&&new Date(u.expiry)<new Date(); const statusText = u.status === 'pending' ? '<span class="text-yellow-400">(Pending)</span>' : (iE ? '<span class="text-red-400">(Expired)</span>' : '<span class="text-emerald-400">(Aktif)</span>'); el.innerHTML=`<div><strong class="block text-sm">${u.displayName||u.username}</strong><span class="text-slate-400">Exp: ${exp} ${statusText}</span><p class="text-slate-500 mt-0.5">Username: ${u.username}</p></div><button onclick="deleteUserAccount('${u.username}')" class="btn btn-danger text-xs p-1.5"><i class="fas fa-user-times"></i></button>`; createdUsersListAdmin.appendChild(el);});}
        window.deleteUserAccount = deleteUserAccount; function deleteUserAccount(uDel) { userCredentialsArray=userCredentialsArray.filter(u=>u.username!==uDel);saveData(LS_KEYS.users,userCredentialsArray);showToast(`Akun "${uDel}" dihapus.`,'success');renderAdminCreatedUsers();}

        // --- Fungsi User ---
        // ... (Sama seperti sebelumnya, pastikan ID DOM benar)
        function renderUserSignals() { if(!signalsContainerUser)return; signalsContainerUser.innerHTML = ''; if (signalsArray.length === 0) { signalsContainerUser.innerHTML = '<p id="loadingMessageUser" class="text-slate-400 text-center py-10 md:col-span-2 lg:col-span-3">Belum ada sinyal.</p>'; return; } signalsArray.forEach(s => { const card = document.createElement('div'); card.className = 'signal-card-item transform transition-all duration-300 hover:scale-[1.03]'; const actCls = s.action === 'BUY' ? 'text-emerald-400' : 'text-red-400'; const ts = new Date(s.timestamp); const time = ts.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }); const date = ts.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'2-digit'}); card.innerHTML = `<div class="flex justify-between items-center mb-2.5"><h3 class="text-xl font-semibold ${actCls}"><i class="fas ${s.action === 'BUY' ? 'fa-chart-line' : 'fa-chart-area'} mr-2.5"></i>${s.action} ${s.asset}</h3><span class="text-xs text-slate-400 bg-slate-700/60 px-2.5 py-1 rounded-md">${date}, ${time}</span></div><p class="text-sm text-slate-200 leading-relaxed">${s.notes || '<span class="italic text-slate-500">- Tanpa catatan -</span>'}</p>`; signalsContainerUser.appendChild(card); }); }
        
        // --- Animasi Ticker Harga ---
        // ... (Sama seperti sebelumnya, pastikan ID DOM benar)
        function updatePriceTicker() { mockMarketAssets.forEach(a => { const v = 0.15 + Math.random()*0.4, cP=(Math.random()-0.498)*v, pC=a.price*(cP/100); a.lastPrices.push(a.price); if(a.lastPrices.length>10)a.lastPrices.shift(); a.price+=pC; a.price=Math.max(0,a.price); a.change=pC; a.direction=pC>0.0000001?'up':(pC<-0.0000001?'down':'neutral');}); renderPriceTicker(); }
        function renderPriceTicker() { if(!tickerItemsContainer) return; tickerItemsContainer.innerHTML=''; mockMarketAssets.forEach(asset => { const iD=document.createElement('div'); iD.className='price-ticker-item text-center'; const pVC=document.createElement('div'); pVC.className='price-value-container'; const pE=document.createElement('span'); pE.className=`price-value ${asset.direction==='up'?'price-up':asset.direction==='down'?'price-down':'price-neutral'}`; const pDec=asset.decimals; pE.textContent=asset.price.toLocaleString('id-ID',{minimumFractionDigits:pDec,maximumFractionDigits:pDec}); const icon=document.createElement('i'); icon.className=`fas text-sm ml-1.5 ${asset.direction==='up'?'fa-arrow-up price-up':asset.direction==='down'?'fa-arrow-down price-down':'fa-minus price-neutral'}`; pVC.appendChild(pE); pVC.appendChild(icon); if(asset.lastPrices.length>0&&asset.price!==asset.lastPrices[asset.lastPrices.length-1]){if(asset.direction==='up')pVC.classList.add('flash-up');else if(asset.direction==='down')pVC.classList.add('flash-down');setTimeout(()=>pVC.classList.remove('flash-up','flash-down'),600);} const aNE=document.createElement('div');aNE.className='asset-name font-semibold text-sky-400 text-base mb-0.5';aNE.textContent=asset.name; const cE=document.createElement('div');cE.className=`price-change-percent text-xs ${asset.direction==='up'?'price-up':asset.direction==='down'?'price-down':'price-neutral'}`; const pctChg = asset.lastPrices.length>0&&asset.lastPrices[0]!==0?((asset.price-asset.lastPrices[0])/asset.lastPrices[0]*100).toFixed(2):"0.00"; cE.innerHTML=`${asset.change.toLocaleString('id-ID',{minimumFractionDigits:pDec,maximumFractionDigits:pDec+2,signDisplay:'always'})} (${pctChg}%)`; iD.appendChild(aNE);iD.appendChild(pVC);iD.appendChild(cE);tickerItemsContainer.appendChild(iD);});}
        function startPriceTicker() { if(tickerIntervalId)clearInterval(tickerIntervalId); renderPriceTicker(); tickerIntervalId=setInterval(updatePriceTicker,1800);}
        function stopPriceTicker() { if(tickerIntervalId)clearInterval(tickerIntervalId); tickerIntervalId=null;}

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            // Muat data dari localStorage atau gunakan default
            signalsArray = parseDatesInArray(loadData(LS_KEYS.signals, []), ['timestamp']);
            userCredentialsArray = parseDatesInArray(loadData(LS_KEYS.users, defaultUserCredentials), ['expiry', 'createdAt']);
            subscriptionPrices = loadData(LS_KEYS.prices, defaultSubscriptionPrices);
            adminPaymentDetails = loadData(LS_KEYS.paymentDetails, defaultAdminPaymentDetails);
            pendingSubscriptions = parseDatesInArray(loadData(LS_KEYS.pendingSubs, []), ['requestTimestamp']);

            const savedUserSession = loadData(LS_KEYS.currentUser);
            if (savedUserSession) {
                const actualUser = userCredentialsArray.find(u => u.username === savedUserSession.username);
                if (actualUser) {
                    if (actualUser.status === 'pending') {
                        showToast(`Akun ${actualUser.username} menunggu konfirmasi.`, 'info');
                        localStorage.removeItem(LS_KEYS.currentUser); 
                        showSection('loginSection');
                    } else if (actualUser.expiry && new Date(actualUser.expiry) < new Date()) {
                        showToast(`Sesi ${actualUser.displayName || actualUser.username} kedaluwarsa. Login ulang.`, 'info');
                        localStorage.removeItem(LS_KEYS.currentUser);
                        showSection('loginSection');
                    } else {
                        currentUser = { username: actualUser.username, role: actualUser.role, email: actualUser.email, displayName: actualUser.displayName || actualUser.username };
                        if (currentUser.role === 'admin') {
                            adminNameDisplay.textContent = currentUser.displayName;
                            // Mengisi ulang form pengaturan admin dengan data yang dimuat
                            document.getElementById('priceDay').value = subscriptionPrices.day;
                            document.getElementById('priceWeek').value = subscriptionPrices.week;
                            document.getElementById('priceMonth').value = subscriptionPrices.month;
                            updateAdminPaymentDisplay(); // Ini akan mengisi input DANA dan preview QRIS
                            
                            renderAdminPendingSubscriptions();
                            showSection('adminSection');
                            renderAdminSentSignals();
                            renderAdminCreatedUsers();
                        } else {
                            userNameDisplay.textContent = currentUser.displayName;
                            showSection('userSection');
                            renderUserSignals();
                            startPriceTicker();
                        }
                    }
                } else {
                    localStorage.removeItem(LS_KEYS.currentUser);
                    showSection('loginSection');
                }
            } else {
                showSection('loginSection');
            }
            renderSubscriptionOptions(); 
            updateAdminPaymentDisplay(); // Panggil juga di sini untuk memastikan tampilan awal admin (jika tidak auto-login) benar
            console.log("Signal Pro Platform (Persisten V4) - Inisialisasi selesai.");
        });
    </script>
</body>
</html>

